<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Researcher System - Paper Analysis</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0f172a;
            --container-bg: #1e293b;
            --card-bg: rgba(30, 41, 59, 0.7);
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent-blue: #3b82f6;
            --accent-green: #10b981;
            --accent-orange: #f59e0b;
            --accent-red: #ef4444;
            --accent-purple: #8b5cf6;
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        body { 
            font-family: 'Outfit', sans-serif; 
            max-width: 1000px; 
            margin: 0 auto; 
            padding: 40px 20px; 
            background-color: var(--bg-color); 
            color: var(--text-primary);
            line-height: 1.6;
        }

        h1 { 
            font-size: 2.5em;
            font-weight: 700;
            background: linear-gradient(135deg, #60a5fa, #c084fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: center; 
            margin-bottom: 40px;
        }

        .container { 
            background: var(--container-bg); 
            padding: 40px; 
            border-radius: 24px; 
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.3);
            border: 1px solid var(--glass-border);
        }

        .upload-section { 
            text-align: center; 
            margin-bottom: 40px; 
            border: 2px dashed var(--glass-border); 
            padding: 50px; 
            border-radius: 20px; 
            transition: all 0.3s ease;
            background: rgba(0,0,0,0.2);
        }

        .upload-section:hover { 
            border-color: var(--accent-blue); 
            background: rgba(59, 130, 246, 0.05);
        }

        input[type="file"] { display: none; }

        label { 
            background: var(--accent-blue); 
            color: white; 
            padding: 12px 28px; 
            border-radius: 12px; 
            cursor: pointer; 
            transition: all 0.2s; 
            display: inline-block;
            font-weight: 600;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }

        label:hover { 
            background: #2563eb; 
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.4);
        }

        button { 
            background: var(--accent-green); 
            color: white; 
            border: none; 
            padding: 12px 30px; 
            border-radius: 12px; 
            cursor: pointer; 
            font-size: 16px; 
            font-weight: 600;
            margin-top: 20px; 
            transition: all 0.2s;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }

        button:hover { 
            background: #059669; 
            transform: scale(1.05);
            box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.4);
        }

        button:disabled { 
            background: #475569; 
            cursor: not-allowed; 
            transform: none;
            box-shadow: none;
        }

        #results { margin-top: 40px; }

        .metric-card { 
            background: var(--card-bg); 
            border-left: 6px solid var(--accent-blue); 
            padding: 24px; 
            margin-bottom: 20px; 
            border-radius: 16px; 
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            transition: transform 0.2s;
        }

        .metric-card:hover { transform: translateY(-4px); }

        .metric-title { 
            font-weight: 600; 
            color: var(--text-secondary); 
            font-size: 0.85em; 
            text-transform: uppercase; 
            letter-spacing: 0.05em;
            margin-bottom: 8px;
        }

        .metric-value { 
            font-size: 2em; 
            font-weight: 700; 
            color: var(--text-primary); 
        }

        .citations-list { list-style-type: none; padding: 0; }

        .citations-list li { 
            background: rgba(0,0,0,0.2); 
            border-radius: 12px;
            padding: 16px; 
            margin-bottom: 12px;
            border: 1px solid var(--glass-border);
        }

        .loader { 
            border: 4px solid rgba(255,255,255,0.1); 
            border-top: 4px solid var(--accent-blue); 
            border-radius: 50%; 
            width: 50px; 
            height: 50px; 
            animation: spin 1s cubic-bezier(0.5, 0, 0.5, 1) infinite; 
            margin: 40px auto; 
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .review-section { 
            margin-top: 40px; 
            padding: 30px; 
            background: rgba(0,0,0,0.2); 
            border-radius: 20px; 
            border: 1px solid var(--glass-border); 
        }

        .review-item { 
            margin-bottom: 16px; 
            background: rgba(255,255,255,0.03);
            padding: 16px;
            border-radius: 12px;
            display: flex; 
            align-items: flex-start; 
        }

        .review-icon { margin-right: 15px; font-size: 1.25em; }
        .strength-icon { color: var(--accent-green); }
        .weakness-icon { color: var(--accent-orange); }
        .redflag-icon { color: var(--accent-red); }

        .review-source {
            font-size: 0.7em;
            color: var(--text-secondary);
            background: rgba(255,255,255,0.05);
            padding: 4px 10px;
            border-radius: 6px;
            margin-top: 8px;
            display: inline-block;
            font-weight: 600;
            text-transform: uppercase;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>üìÑ Research PDF Analyzer</h1>
    
    <div class="upload-section" id="drop-zone">
        <p>Drag & Drop paper (PDF/DOCX) here or</p>
        <input type="file" id="fileInput" accept=".pdf,.docx">
        <label for="fileInput">Choose File</label>
        <br><br>
        <div id="fileName" style="font-style: italic; color: #7f8c8d; margin-bottom: 15px;"></div>
        
        <div>
            <label for="doiInput" style="background: none; color: #333; cursor: default; padding: 0;">Optional DOI (for Published Papers):</label><br>
            <input type="text" id="doiInput" placeholder="e.g. 10.1145/1234567.890" style="padding: 10px; border-radius: 4px; border: 1px solid #ccc; width: 80%; max-width: 300px; margin-top: 5px;">
        </div>
        
        <button id="analyzeBtn">Analyze Document</button>
    </div>

    <div class="loader" id="loader"></div>

    <div id="results">
        <h2>Analysis Results <span id="analysisModeBadge" style="font-size: 0.5em; background: var(--accent-blue); color: white; padding: 6px 14px; border-radius: 20px; vertical-align: middle; margin-left: 10px; font-weight: 600; text-transform: uppercase;">Mode: Unknown</span></h2>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
            <div class="metric-card" style="border-left-color: #3498db;">
                <div class="metric-title">Integrity Score</div>
                <div class="metric-value" id="integrityScore">-</div>
                <div id="integrityBreakdown" style="display:none; font-size: 0.6em; margin-top: 10px; color: #7f8c8d; text-align: left; line-height: 1.2;"></div>
            </div>
            <div class="metric-card" style="border-left-color: #2ecc71;">
                <div class="metric-title">Claims Found</div>
                <div class="metric-value" id="claimsCount">-</div>
            </div>
            <div class="metric-card" style="border-left-color: #e74c3c;">
                <div class="metric-title">Vague Claims</div>
                <div class="metric-value" id="vagueCount">-</div>
            </div>
            <div class="metric-card" style="border-left-color: #f1c40f;">
                <div class="metric-title">References Found</div>
                <div class="metric-value" id="citationsCount">-</div>
                <div id="apiPill" style="display:none; margin-top: 10px; font-size: 0.7em; background: var(--accent-purple); color: white; padding: 4px 10px; border-radius: 8px; text-align: center; width: fit-content; font-weight: 600;"></div>
            </div>
             <div class="metric-card" style="border-left-color: #9b59b6;">
                <div class="metric-title">Avg Relevance</div>
                <div class="metric-value" id="avgRelevance">-</div>
            </div>
             <div class="metric-card" style="border-left-color: #34495e;">
                <div class="metric-title">Self-Citation Ratio</div>
                <div class="metric-value" id="selfCitationRatio">-</div>
            </div>
        </div>

        <div id="pdfViewerContainer" style="margin-top: 30px; display: none;">
            <h3>Document Viewer (Highlighted)</h3>
            <iframe id="pdfViewer" src="" style="width: 100%; height: 600px; border: 1px solid #ccc; border-radius: 4px;"></iframe>
        </div>

        <div id="datasetAnalysis" style="margin-top: 30px;">
            <h3>Dataset Analysis</h3>
            <div id="datasetFoundText" style="margin-bottom: 10px; color: #7f8c8d;"></div>
            <ul class="citations-list" id="outdatedDatasetList"></ul>
        </div>

        <div id="systemReview" class="review-section" style="display:none;">
            <h3>System Peer-Review & Reasoning</h3>
            <div id="reviewContainer"></div>
        </div>

        <div id="falseCitationsContainer" style="margin-top: 30px;">
            <h3>Suspicious / False Citations</h3>
            <div style="font-size: 0.9em; color: #7f8c8d; margin-bottom: 10px;">Citations whose context does not semantically match the cited paper's abstract.</div>
            <ul class="citations-list" id="falseCitationsList"></ul>
        </div>

        <div id="foundCitationsContainer" style="margin-top: 30px;">
            <h3>Found Citations</h3>
            <ul class="citations-list" id="citationsList">
                <!-- Citations will be injected here -->
            </ul>
        </div>
        
        <div id="apiMetadataContainer" style="margin-top: 30px; display: none;"></div>
    </div>
</div>

<script>
    const fileInput = document.getElementById('fileInput');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const fileNameDisplay = document.getElementById('fileName');
    const loader = document.getElementById('loader');
    const resultsDiv = document.getElementById('results');

    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            fileNameDisplay.textContent = e.target.files[0].name;
            analyzeBtn.disabled = false;
        } else {
            fileNameDisplay.textContent = '';
            analyzeBtn.disabled = true;
        }
    });

    analyzeBtn.addEventListener('click', async () => {
        const file = fileInput.files[0];
        const doi = document.getElementById('doiInput').value.trim();
        
        if (!file && !doi) {
            alert('Please upload a PDF or provide a DOI.');
            return;
        }

        // Reset UI
        resultsDiv.style.display = 'none';
        loader.style.display = 'block';
        analyzeBtn.disabled = true;

        const formData = new FormData();
        if (file) formData.append('file', file);
        if (doi) formData.append('doi', doi);

        try {
            const response = await fetch('/analyze', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || error.error || 'Analysis failed');
            }

            const data = await response.json();
            displayResults(data);

        } catch (error) {
            alert('Error: ' + error.message);
        } finally {
            loader.style.display = 'none';
            analyzeBtn.disabled = false;
        }
    });

    function displayResults(data) {
        // Set Mode Badge
        const badge = document.getElementById('analysisModeBadge');
        if (data.analysis_mode === "MATCHED_HYBRID") {
            badge.textContent = "Mode: Full Analysis (Matched)";
            badge.style.background = "#2ecc71";
        } else if (data.analysis_mode === "MATCHED_HYBRID_WARN") {
            badge.textContent = "Mode: API Metadata-Only (Title Mismatch: PDF Ignored)";
            badge.style.background = "#e67e22";
        } else if (data.analysis_mode === "PDF_ONLY") {
            badge.textContent = "Mode: PDF-Only (Heuristics)";
            badge.style.background = "#f39c12";
        } else if (data.analysis_mode === "DOI_ONLY") {
            badge.textContent = "Mode: API Metadata-Only";
            badge.style.background = "#9b59b6";
        } else {
            badge.textContent = "Mode: Unknown";
            badge.style.background = "#7f8c8d";
        }
    
        // Optional display toggling based on mode
        const isDoiOnly = data.analysis_mode === "DOI_ONLY" || data.analysis_mode === "MATCHED_HYBRID_WARN";
        
        if (data.integrity_score !== undefined && data.integrity_score !== null) {
            document.getElementById('integrityScore').textContent = data.integrity_score.toFixed(2);
            
            // Transparency Breakdown
            const breakdown = data.integrity_breakdown || {};
            const breakdownDiv = document.getElementById('integrityBreakdown');
            breakdownDiv.style.display = 'block';
            
            let breakdownHtml = '<div style="border-top: 1px solid #eee; padding-top: 5px; margin-top: 5px;"><strong>Breakdown:</strong><br>';
            if (breakdown.self_citation > 0) breakdownHtml += `‚Ä¢ Self-Cit: -${breakdown.self_citation}<br>`;
            if (breakdown.vague_claims > 0) breakdownHtml += `‚Ä¢ Vague: -${breakdown.vague_claims}<br>`;
            if (breakdown.false_citations > 0) breakdownHtml += `‚Ä¢ False Cit: -${breakdown.false_citations}<br>`;
            if (breakdown.outdated_datasets > 0) breakdownHtml += `‚Ä¢ Outdated: -${breakdown.outdated_datasets}<br>`;
            if (breakdown.low_relevance > 0) breakdownHtml += `‚Ä¢ Low Rel: -${breakdown.low_relevance}<br>`;
            if (breakdown.freshness_bonus > 0) breakdownHtml += `‚Ä¢ Fresh Bonus: +${breakdown.freshness_bonus}`;
            breakdownHtml += '</div>';
            breakdownDiv.innerHTML = breakdownHtml;
        } else {
            document.getElementById('integrityScore').textContent = "N/A";
            document.getElementById('integrityBreakdown').style.display = 'none';
        }
        
        if (isDoiOnly) {
            document.getElementById('claimsCount').textContent = "N/A";
            document.getElementById('vagueCount').textContent = "N/A";
            document.getElementById('avgRelevance').textContent = "N/A";
            
            // Hide PDF-dependent containers
            document.getElementById('datasetAnalysis').style.display = 'none';
            document.getElementById('falseCitationsContainer').style.display = 'none';
            document.getElementById('foundCitationsContainer').style.display = 'none';
            
            // Show API Metadata
            if (data.paper_metadata) {
                const apiContainer = document.getElementById('apiMetadataContainer');
                apiContainer.style.display = 'block';
                
                const pm = data.paper_metadata;
                const authors = pm.authors ? pm.authors.map(a => a.display_name).filter(Boolean).join(', ') : 'Unknown';
                const abstractUrl = pm.id ? `<a href="${pm.id}" target="_blank">View on OpenAlex ‚Üó</a>` : '';
                
                apiContainer.innerHTML = `
                    <h3>API Metadata (OpenAlex)</h3>
                    <div style="background: #f8f9fa; border-left: 5px solid #9b59b6; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 10px 0; color: #2c3e50;">${pm.title || 'Untitled'}</h4>
                        <div style="font-size: 0.9em; color: #34495e; margin-bottom: 10px;">
                            <strong>Authors:</strong> ${authors}<br>
                            <strong>Publication Year:</strong> ${pm.publication_year || 'Unknown'}<br>
                            <strong>Type:</strong> ${pm.type || 'Unknown'} | <strong>Open Access:</strong> ${pm.is_oa ? 'Yes' : 'No'}
                        </div>
                        <div style="margin-top: 10px; font-size: 0.8em;">${abstractUrl}</div>
                    </div>
                `;
            } else {
                document.getElementById('apiMetadataContainer').style.display = 'none';
            }
        } else {
            // Ensure PDF containers are visible for Hybrid/PDF
            document.getElementById('datasetAnalysis').style.display = 'block';
            document.getElementById('falseCitationsContainer').style.display = 'block';
            document.getElementById('foundCitationsContainer').style.display = 'block';
            
            // Populate System Review
            const review = data.system_review || { strengths: [], weaknesses: [], red_flags: [] };
            const reviewSec = document.getElementById('systemReview');
            const reviewCont = document.getElementById('reviewContainer');
            reviewCont.innerHTML = '';
            
            let hasReview = false;
            
            // Render Red Flags First (Highest Importance)
            review.red_flags.forEach(rf => {
                const text = typeof rf === 'string' ? rf : rf.text;
                const source = typeof rf === 'string' ? 'Legacy Checker' : rf.source;
                reviewCont.innerHTML += `
                    <div class="review-item">
                        <span class="review-icon redflag-icon">üö©</span> 
                        <div>
                            <strong>Critical:</strong> ${text}
                            <div class="review-source">Detected by: ${source}</div>
                        </div>
                    </div>`;
                hasReview = true;
            });
            
            // Render Weaknesses
            review.weaknesses.forEach(w => {
                const text = typeof w === 'string' ? w : w.text;
                const source = typeof w === 'string' ? 'Legacy Checker' : w.source;
                reviewCont.innerHTML += `
                    <div class="review-item">
                        <span class="review-icon weakness-icon">‚ö†Ô∏è</span> 
                        <div>
                            <strong>Weakness:</strong> ${text}
                            <div class="review-source">Detected by: ${source}</div>
                        </div>
                    </div>`;
                hasReview = true;
            });
            
            // Render Strengths
            review.strengths.forEach(s => {
                const text = typeof s === 'string' ? s : s.text;
                const source = typeof s === 'string' ? 'Legacy Checker' : s.source;
                reviewCont.innerHTML += `
                    <div class="review-item">
                        <span class="review-icon strength-icon">‚úÖ</span> 
                        <div>
                            <strong>Strength:</strong> ${text}
                            <div class="review-source">Detected by: ${source}</div>
                        </div>
                    </div>`;
                hasReview = true;
            });
            
            if (hasReview) reviewSec.style.display = 'block';
            else reviewSec.style.display = 'none';

            // For MATCHED_HYBRID, also show the API Metadata container
            if (data.analysis_mode === "MATCHED_HYBRID" && data.paper_metadata) {
                const apiContainer = document.getElementById('apiMetadataContainer');
                apiContainer.style.display = 'block';
                const pm = data.paper_metadata;
                const authors = pm.authors ? pm.authors.map(a => a.display_name).filter(Boolean).join(', ') : 'Unknown';
                const abstractUrl = pm.id ? `<a href="${pm.id}" target="_blank">View on OpenAlex ‚Üó</a>` : '';
                
                apiContainer.innerHTML = `
                    <h3>Paper Verified via OpenAlex API</h3>
                    <div style="background: #f8f9fa; border-left: 5px solid #2ecc71; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 10px 0; color: #2c3e50;">${pm.title || 'Untitled'}</h4>
                        <div style="font-size: 0.9em; color: #34495e; margin-bottom: 10px;">
                            <strong>Authors:</strong> ${authors}<br>
                            <strong>Publication Year:</strong> ${pm.publication_year || 'Unknown'}<br>
                        </div>
                        <div style="margin-top: 10px; font-size: 0.8em;">${abstractUrl}</div>
                    </div>
                `;
            } else {
                document.getElementById('apiMetadataContainer').style.display = 'none';
            }
            
            const totalClaims = (data.claims || 0) + (data.vague_claims || 0);
            document.getElementById('claimsCount').textContent = totalClaims;
            document.getElementById('vagueCount').textContent = data.vague_claims;
            
            let avgRel = data.avg_relevance;
            if (avgRel !== undefined && avgRel !== null) {
                avgRel = Math.max(0, avgRel); // clamp negative to 0
                document.getElementById('avgRelevance').textContent = avgRel.toFixed(4);
            } else {
                document.getElementById('avgRelevance').textContent = 'N/A';
            }
        }
        
        document.getElementById('citationsCount').textContent = data.total_citations_count || data.citations || '0';
        
        const apiPill = document.getElementById('apiPill');
        if (data.cited_by_count !== undefined && data.cited_by_count !== null) {
            apiPill.style.display = 'block';
            
            let pillHtml = `<div>API Cited by: ${data.cited_by_count}</div>`;
            if (data.api_references_count !== undefined && data.api_references_count !== null) {
                pillHtml += `<div style="margin-top:2px;">API References: ${data.api_references_count}</div>`;
            }
            apiPill.innerHTML = pillHtml;
        } else {
            apiPill.style.display = 'none';
        }
        
        // Handle negative relevance - clamp to 0 or display N/A if missing
        let avgRel = data.avg_relevance;
        if (avgRel !== undefined && avgRel !== null) {
            avgRel = Math.max(0, avgRel); // clamp negative to 0
            document.getElementById('avgRelevance').textContent = avgRel.toFixed(4);
        } else {
            document.getElementById('avgRelevance').textContent = 'N/A';
        }
        
        const selfCitCount = data.self_citation_count || 0;
        document.getElementById('selfCitationRatio').textContent = `${(data.self_citation_ratio * 100).toFixed(1)}% (${selfCitCount})`;

        // Display Download Button if available
        const resultsHeader = document.querySelector('#results h2');
        const existingBtn = document.getElementById('downloadBtn');
        if (existingBtn) existingBtn.remove();
        
        if (data.highlighted_pdf_url) {
            const btn = document.createElement('a');
            btn.id = 'downloadBtn';
            btn.href = data.highlighted_pdf_url;
            btn.textContent = '‚¨á Download Highlighted PDF';
            btn.className = 'download-btn';
            btn.style.cssText = 'display: inline-block; background: var(--accent-purple); color: white; padding: 10px 20px; border-radius: 12px; text-decoration: none; margin-left: 20px; font-size: 0.8em; vertical-align: middle; font-weight: 600; transition: all 0.2s;';
            btn.download = 'highlighted_paper.pdf';
            resultsHeader.appendChild(btn);
            
            // Show PDF in iframe
            const pdfContainer = document.getElementById('pdfViewerContainer');
            const pdfViewer = document.getElementById('pdfViewer');
            pdfViewer.src = data.highlighted_pdf_url;
            pdfContainer.style.display = 'block';
        } else {
            document.getElementById('pdfViewerContainer').style.display = 'none';
        }

        // Display Citations
        const list = document.getElementById('citationsList');
        list.innerHTML = '';
        
        if (data.citation_list && data.citation_list.length > 0) {
            data.citation_list.forEach(cit => {
                const li = document.createElement('li');
                li.textContent = cit;
                list.appendChild(li);
            });
        } else {
            const li = document.createElement('li');
            li.textContent = 'No citations found.';
            li.style.color = '#7f8c8d';
            list.appendChild(li);
        }

        // Display Dataset Analysis
        const datasetAnalysis = document.getElementById('datasetAnalysis');
        const datasetFoundText = document.getElementById('datasetFoundText');
        const outdatedDatasetList = document.getElementById('outdatedDatasetList');
        
        // Remove existing market comparison if any
        let existingMarketCmp = document.getElementById('marketComparisonDiv');
        if (existingMarketCmp) existingMarketCmp.remove();
        
        if (data.datasets_found && data.datasets_found.length > 0) {
            datasetFoundText.textContent = `Named Datasets Found: ${data.datasets_found.join(', ')}`;
            outdatedDatasetList.innerHTML = '';
            
            if (data.outdated_datasets && data.outdated_datasets.length > 0) {
                data.outdated_datasets.forEach(warn => {
                    const li = document.createElement('li');
                    li.style.borderLeft = "4px solid #e74c3c";
                    li.innerHTML = `<strong>‚ö†Ô∏è ${warn.dataset}</strong>: ${warn.reason}`;
                    outdatedDatasetList.appendChild(li);
                });
            } else {
                const li = document.createElement('li');
                li.style.color = '#2ecc71';
                li.textContent = '‚úì All datasets used appear to be acceptable (no outdated warnings).';
                outdatedDatasetList.appendChild(li);
            }
            
            if (data.market_comparison) {
                const cmp = data.market_comparison;
                const cmpDiv = document.createElement('div');
                cmpDiv.id = 'marketComparisonDiv';
                cmpDiv.style.marginTop = "15px";
                cmpDiv.style.padding = "15px";
                cmpDiv.style.backgroundColor = "#e8f4f8";
                cmpDiv.style.borderRadius = "5px";
                cmpDiv.style.borderLeft = "5px solid #3498db";
                cmpDiv.style.color = "#333";
                
                cmpDiv.innerHTML = `
                    <h4 style="margin-top:0; color:#2c3e50;">üìä Market Comparison: ${cmp.domain}</h4>
                    <p style="font-size: 0.9em; color:#34495e; margin-bottom: 10px;">${cmp.analysis}</p>
                    <div style="font-size: 0.85em; color: #333;">
                        <strong>Latest Available Benchmarks:</strong> ${cmp.latest_available.join(', ')}<br/>
                        ${cmp.missed && cmp.missed.length > 0 ? `<strong style="color: #e74c3c;">Missed Opportunities:</strong> <span style="color: #333;">${cmp.missed.join(', ')}</span>` : `<strong style="color: #2ecc71;">‚úì Author used top alternatives.</strong>`}
                    </div>
                `;
                datasetAnalysis.appendChild(cmpDiv);
            }
        } else {
            datasetFoundText.textContent = 'No known datasets were detected in this paper.';
            outdatedDatasetList.innerHTML = '';
            const li = document.createElement('li');
            li.style.color = '#7f8c8d';
            li.textContent = 'System found no recognized datasets to evaluate.';
            outdatedDatasetList.appendChild(li);
        }

        // Display False Citations
        const falseContainer = document.getElementById('falseCitationsContainer');
        const falseList = document.getElementById('falseCitationsList');
        
        if (data.false_citations && data.false_citations.length > 0) {
            falseList.innerHTML = '';
            
            data.false_citations.forEach(fc => {
                const li = document.createElement('li');
                li.style.borderLeft = "4px solid #e67e22";
                li.innerHTML = `
                    <div style="margin-bottom: 5px;"><strong>Citation:</strong> ${fc.citation}</div>
                    <div style="margin-bottom: 5px; font-style: italic; color: #34495e;">Context: "${fc.context}"</div>
                    <div style="margin-bottom: 5px; font-size: 0.85em; color: #7f8c8d;"><strong>Abstract:</strong> ${fc.abstract_snippet}</div>
                    <div style="font-size: 0.85em; color: #c0392b;"><strong>Flag:</strong> ${fc.reasoning} (Sim: ${fc.similarity_score.toFixed(2)})</div>
                `;
                falseList.appendChild(li);
            });
        } else {
            falseList.innerHTML = '';
            const li = document.createElement('li');
            li.style.color = '#2ecc71';
            li.textContent = '‚úì No false or suspicious citations detected.';
            falseList.appendChild(li);
        }

        
        // Hide existing claims container (prevent duplication)
        const existingClaims = document.getElementById('claimsContainer');
        if (existingClaims) existingClaims.remove();
        
        if (!isDoiOnly) {
            const claimsContainer = document.createElement('div');
            claimsContainer.id = 'claimsContainer';
            claimsContainer.style.marginTop = '30px';
            claimsContainer.innerHTML = '<h3>Research Findings & Claims</h3><div id="claimsList"></div>';
            document.getElementById('results').appendChild(claimsContainer);
            
            const claimsList = document.getElementById('claimsList');
            const allClaims = [...(data.solid_claims || []), ...(data.vague_claims_list || [])];
        
        if (allClaims.length > 0) {
            allClaims.forEach(claim => {
                const card = document.createElement('div');
                card.className = 'metric-card';
                card.style.borderLeft = claim.is_outdated ? "5px solid #e74c3c" : "5px solid #2ecc71";
                card.style.padding = "15px";
                card.style.marginBottom = "10px";
                
                const decayColors = { FAST: "#e74c3c", MEDIUM: "#f39c12", SLOW: "#3498db", TIMELESS: "#9b59b6" };
                const decayColor = decayColors[claim.decay_type] || "#7f8c8d";
                
                const variablesHtml = claim.moving_variables && claim.moving_variables.length > 0 
                    ? `<div style="font-size: 0.8em; color: #e67e22; margin-top: 5px;">‚ö†Ô∏è Moving Variables: ${claim.moving_variables.join(', ')}</div>` 
                    : '';

                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <span style="font-weight: 500;">${claim.text}</span>
                        <span style="background: ${decayColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7em; white-space: nowrap; margin-left:10px;">
                            ${claim.decay_type}
                        </span>
                    </div>
                    <div style="margin-top: 10px; font-size: 0.85em; display: flex; gap: 15px; color: #7f8c8d;">
                        <span>Freshness: <strong>${claim.freshness_score}%</strong></span>
                        <span>Half-life: <strong>${claim.half_life}y</strong></span>
                    </div>
                    ${variablesHtml}
                    <div style="margin-top: 8px; padding: 8px; background: rgba(0,0,0,0.03); border-radius: 4px; font-size: 0.8em;">
                        <div style="margin-bottom: 4px;"><strong>üõ° Stress Test:</strong> ${claim.stress_test}</div>
                        <div><strong>ü§ù Consensus:</strong> ${claim.consensus}</div>
                    </div>
                    <div style="font-size: 0.75em; color: #95a5a6; margin-top: 8px; font-style: italic;">
                        Analysis: ${claim.reason}
                    </div>
                `;
                claimsList.appendChild(card);
            });
            } else {
                const li = document.createElement('div');
                li.textContent = 'No specific claims extracted.';
                li.style.color = '#7f8c8d';
                claimsList.appendChild(li);
            }
        }
        // Display Word Forensics
        const existingForensics = document.getElementById('wordForensicsContainer');
        if (existingForensics) existingForensics.remove();

        if (data.word_forensics) {
            const wf = data.word_forensics;
            const container = document.createElement('div');
            container.id = 'wordForensicsContainer';
            container.className = 'review-section';
            container.style.marginTop = '30px';
            container.style.borderLeft = wf.risk_level === 'HIGH' ? "6px solid #e74c3c" : wf.risk_level === 'MEDIUM' ? "6px solid #f39c12" : "6px solid #2ecc71";

            let flagsHtml = wf.forensic_flags.map(f => `
                <div class="review-item">
                    <span class="review-icon ${f.type === 'RED_FLAG' ? 'redflag-icon' : 'weakness-icon'}">
                        ${f.type === 'RED_FLAG' ? 'üö©' : '‚ö†Ô∏è'}
                    </span>
                    <span><strong>${f.type}:</strong> ${f.detail}</span>
                </div>
            `).join('');

            container.innerHTML = `
                <h3 style="margin-top: 0; display: flex; justify-content: space-between;">
                    üïµÔ∏è Document Forensics (Word-Only) 
                    <span style="font-size: 0.6em; background: ${wf.risk_level === 'HIGH' ? '#e74c3c' : wf.risk_level === 'MEDIUM' ? '#f39c12' : '#2ecc71'}; color: white; padding: 5px 10px; border-radius: 20px;">
                        Risk: ${wf.risk_level}
                    </span>
                </h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; font-size: 0.9em;">
                    <div>üë§ <strong>Creator:</strong> ${wf.metadata.creator}</div>
                    <div>üïí <strong>Editing Time:</strong> ${wf.metadata.total_editing_time} min</div>
                    <div>üìÖ <strong>Created:</strong> ${wf.metadata.created}</div>
                    <div>üîÑ <strong>Revision:</strong> ${wf.metadata.revision}</div>
                </div>
                ${flagsHtml || '<p style="color: #2ecc71;">‚úì No suspicious editing anomalies or metadata leaks detected.</p>'}
            `;
            document.getElementById('results').appendChild(container);
        }

        resultsDiv.style.display = 'block';
    }
</script>

</body>
</html>
